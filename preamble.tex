% =============================================================================
% رفيق الرعاية — تنسيق احترافي احترافي B5 بجودة النشر
% Publisher Quality Professional Preamble
% =============================================================================

% ═══════════════════════════════════════════════════════════════════════════
% 1. PAPER SIZE & GEOMETRY — B5 with Golden Ratio Margins
% ═══════════════════════════════════════════════════════════════════════════
\usepackage[
  b5paper,                    % B5 format (176 x 250 mm)
  top=25mm,                   % Top margin
  bottom=25mm,                % Bottom margin
  inner=25mm,                 % Inner margin (binding side)
  outer=20mm,                 % Outer margin (slightly smaller - golden ratio inspired)
  headheight=14pt,            % Header height
  headsep=8mm,                % Space between header and text
  footskip=10mm,              % Space for footer
  marginparwidth=15mm,        % Margin notes width
  marginparsep=3mm            % Space to margin notes
]{geometry}

% ═══════════════════════════════════════════════════════════════════════════
% 2. MICROTYPE — Professional Microtypography (CRITICAL FOR QUALITY)
% ═══════════════════════════════════════════════════════════════════════════
% Note: microtype has limited support for RTL, but we enable what works
\usepackage[
  activate={true,nocompatibility},  % Activate protrusion and expansion
  final,                            % Enable in final mode
  tracking=false,                   % Disable tracking (spacing issues with Arabic)
  kerning=false,                    % Disable kerning (not needed for Arabic)
  spacing=true,                     % Enable spacing adjustments
  factor=1100,                      % Protrusion factor (110%)
  stretch=20,                       % Font expansion: stretch by 2%
  shrink=20                         % Font expansion: shrink by 2% (helps fitting)
]{microtype}

% Fine-tune microtype settings for better paragraph fitting
\microtypecontext{spacing=nonfrench}

% ═══════════════════════════════════════════════════════════════════════════
% 3. COLORS — Professional Color Palette
% ═══════════════════════════════════════════════════════════════════════════
\usepackage{xcolor}
\definecolor{chaptercolor}{RGB}{25,55,85}       % Deep blue for chapters
\definecolor{sectioncolor}{RGB}{35,70,105}      % Medium blue for sections
\definecolor{accentcolor}{RGB}{60,90,120}       % Accent color
\definecolor{rulecolor}{RGB}{100,120,140}       % Decorative rules

% ═══════════════════════════════════════════════════════════════════════════
% 4. FONTS & TYPOGRAPHY — Professional RTL Arabic Setup
% ═══════════════════════════════════════════════════════════════════════════
\usepackage{fontspec}
\usepackage{polyglossia}
\setmainlanguage[numerals=maghrib]{arabic}
\setotherlanguage{english}

% Amiri is an excellent choice for professional Arabic typography
% Scale optimized for B5 readability
\newfontfamily\arabicfont[
  Script=Arabic,
  Scale=1.05,                       % Slightly larger for better readability
  Ligatures=TeX,
  Mapping=arabicdigits
]{Amiri}

\setmainfont[
  Script=Arabic,
  Scale=1.05,
  Ligatures=TeX,
  Mapping=arabicdigits
]{Amiri}

\newfontfamily\englishfont[
  Ligatures=TeX,
  Numbers=OldStyle
]{TeX Gyre Termes}

% ═══════════════════════════════════════════════════════════════════════════
% 5. PAGE BREAKING & PENALTIES — MAXIMUM QUALITY (CRITICAL!)
% ═══════════════════════════════════════════════════════════════════════════

% === Widow and Orphan Control (MAXIMUM PENALTIES) ===
\widowpenalty=10000                 % Prevent widows (last line alone on new page)
\clubpenalty=10000                  % Prevent orphans (first line alone at bottom)
\brokenpenalty=10000                % Prevent broken words across pages

% === Display Penalties (keep equations/lists together) ===
\displaywidowpenalty=10000          % Widow penalty before display math
\predisplaypenalty=10000            % Penalty before display environments
\postdisplaypenalty=10000           % Penalty after display environments

% === Paragraph Breaking Penalties ===
\interlinepenalty=0                 % Allow breaks between lines (needed for flexibility)
\hyphenpenalty=50                   % Low penalty for hyphenation (Arabic rarely needs this)
\exhyphenpenalty=50                 % Explicit hyphen penalty

% === Page Breaking Control ===
\raggedbottom                       % Allow variable page heights (better than stretching)
\sloppypar                          % Allow slightly looser spacing to avoid overfull boxes

% === Emergency Stretch — Allow paragraphs to stretch/shrink ===
\emergencystretch=3em               % Maximum emergency stretch (helps avoid overfull boxes)
\tolerance=9999                     % Very high tolerance for line breaking
\hbadness=9999                      % Don't warn about underfull hboxes
\vbadness=9999                      % Don't warn about underfull vboxes

% === Flexible Spacing for Better Page Breaks — COMPACT ===
\setlength{\parskip}{5pt plus 2pt minus 1pt}    % Reduced paragraph spacing (was 7pt)
\setlength{\parindent}{0pt}                      % No paragraph indentation

% === Line Spacing — Compact for B5 ===
\linespread{1.15}                   % Reduced to 1.15 (was 1.18) for compactness
                                    % Still maintains good readability

% === Flexible Vertical Spacing — COMPACT ===
\setlength{\topskip}{8pt plus 2pt minus 1pt}    % Reduced from 10pt
\setlength{\parskip}{5pt plus 2pt minus 1pt}    % Reduced from 7pt

% === Prevent Page Breaks After Headings (Sticky Headings) ===
\usepackage{needspace}              % For \needspace command

% ═══════════════════════════════════════════════════════════════════════════
% 6. ADVANCED SQUEEZE COMMANDS — Font Shrinking for Tight Fitting
% ═══════════════════════════════════════════════════════════════════════════

% Command to slightly shrink text to fit on previous page (use sparingly!)
\newcommand{\squeezepage}{%
  \enlargethispage{2\baselineskip}%           % Add 2 extra lines to page
  \setlength{\parskip}{4pt plus 1pt minus 2pt}% Tighter paragraph spacing
}

% Command for maximum squeeze (emergency use only)
\newcommand{\maxsqueeze}{%
  \enlargethispage{3\baselineskip}%           % Add 3 extra lines
  \setlength{\parskip}{3pt plus 1pt minus 2pt}% Very tight spacing
  \linespread{1.10}\selectfont%               % Tighter line spacing
}

% Restore normal spacing after squeeze
\newcommand{\normalsqueeze}{%
  \setlength{\parskip}{5pt plus 2pt minus 1pt}%  % Updated to match new default
  \linespread{1.15}\selectfont%                   % Updated to match new default
}

% ═══════════════════════════════════════════════════════════════════════════
% 7. CHAPTER & SECTION FORMATTING — Elegant Professional Design
% ═══════════════════════════════════════════════════════════════════════════
\usepackage{titlesec}
\usepackage{titletoc}

% === CHAPTER FORMAT — Elegant & Compact ===
\titleformat{\chapter}[display]
  {\normalfont\centering}
  {% Chapter number
    \vspace*{-10pt}%                 % Minimal top space (negative to compensate)
    \textcolor{chaptercolor}{%
      \fontsize{42}{48}\selectfont\bfseries\arabic{chapter}%  % Smaller number
    }%
  }
  {0pt}
  {% Chapter title
    \vspace{0.3cm}%                  % Reduced from 0.7cm
    \fontsize{20}{26}\selectfont\bfseries\textcolor{chaptercolor}%  % Slightly smaller
  }
  [% After chapter title
    \vspace{0.2cm}%                  % Reduced from 0.5cm
    \textcolor{rulecolor}{\rule{0.25\textwidth}{0.8pt}}%  % Slightly thinner rule
    \vspace{0.5cm}%                  % Reduced from 1cm
  ]

% Chapter spacing - prevent orphan chapters
\titlespacing*{\chapter}
  {0pt}                             % Left margin
  {-20pt}                           % Negative space before (pulls chapter up)
  {20pt plus 8pt minus 3pt}         % Space after (reduced, flexible)

% === SECTION FORMAT — Clean & Compact ===
\titleformat{\section}
  {\normalfont\fontsize{15}{19}\selectfont\bfseries\color{sectioncolor}}  % Slightly smaller
  {}                                % No number prefix
  {0pt}
  {}                                % Section title
  [\vspace{1pt}\textcolor{accentcolor}{\rule{0.12\textwidth}{0.5pt}}] % Shorter underline

\titlespacing*{\section}
  {0pt}                             % Left margin
  {16pt plus 3pt minus 2pt}         % Space before (reduced from 22pt)
  {10pt plus 2pt minus 1pt}         % Space after (reduced from 14pt)

% === SUBSECTION FORMAT — Subtle & Compact ===
\titleformat{\subsection}
  {\normalfont\fontsize{13}{16}\selectfont\bfseries\color{black!85}}  % Slightly smaller
  {}
  {0pt}
  {}

\titlespacing*{\subsection}
  {0pt}
  {14pt plus 2pt minus 1pt}         % Space before (reduced from 18pt)
  {8pt plus 1pt minus 1pt}          % Space after (reduced from 10pt)

% === Prevent Heading Orphans — CRITICAL ===
% Never allow headings to appear alone at bottom of page
\newcommand{\chapternobreak}{\needspace{8\baselineskip}}
\newcommand{\sectionnobreak}{\needspace{4\baselineskip}}
\newcommand{\subsectionnobreak}{\needspace{3\baselineskip}}

% Automatically apply to all headings (hooks into titlesec)
\let\oldchapter\chapter
\renewcommand{\chapter}{\clearpage\chapternobreak\oldchapter}

\let\oldsection\section
\renewcommand{\section}{\sectionnobreak\oldsection}

\let\oldsubsection\subsection
\renewcommand{\subsection}{\subsectionnobreak\oldsubsection}

% ═══════════════════════════════════════════════════════════════════════════
% 8. GRAPHICS & TABLES — Professional & Compact
% ═══════════════════════════════════════════════════════════════════════════
\usepackage{graphicx}
\usepackage{booktabs}
\usepackage{longtable}
\usepackage{array}
\usepackage{tabularx}
\usepackage{multirow}
\usepackage{colortbl}

% Table styling - Compact & Professional
\renewcommand{\arraystretch}{1.3}                    % Reduced from 1.4 for compactness
\newcommand{\tableheadercolor}{\rowcolor{chaptercolor!12}}  % Lighter color

% Better spacing in table rules
\setlength{\aboverulesep}{0pt}
\setlength{\belowrulesep}{0pt}
\setlength{\extrarowheight}{3pt}                     % Add padding to rows

% Column types for better RTL alignment
\newcolumntype{R}[1]{>{\raggedleft\arraybackslash}p{#1}}  % Right-aligned
\newcolumntype{L}[1]{>{\raggedright\arraybackslash}p{#1}} % Left-aligned
\newcolumntype{C}[1]{>{\centering\arraybackslash}p{#1}}   % Centered

% Better table environment wrapper for compact tables
\newenvironment{compacttable}
  {\setlength{\extrarowheight}{2pt}\small}  % Smaller font, tight rows
  {}

% Helper for table headers with better spacing
\newcommand{\thead}[1]{\textbf{#1}}         % Bold headers

% ═══════════════════════════════════════════════════════════════════════════
% 9. LISTS — Compact Professional Formatting
% ═══════════════════════════════════════════════════════════════════════════
\usepackage{enumitem}

% Compact list settings for better space usage
\setlist[itemize]{
  itemsep=3pt plus 1pt minus 1pt,   % Tighter item spacing
  parsep=1pt,
  topsep=6pt plus 2pt minus 1pt,    % Reduced top spacing
  partopsep=1pt,
  leftmargin=*,
  label={\textcolor{accentcolor}{•}}
}

\setlist[enumerate]{
  itemsep=3pt plus 1pt minus 1pt,   % Tighter spacing
  parsep=1pt,
  topsep=6pt plus 2pt minus 1pt,    % Reduced top spacing
  partopsep=1pt,
  leftmargin=*
}

% ═══════════════════════════════════════════════════════════════════════════
% 10. HEADERS & FOOTERS — Professional Page Headers
% ═══════════════════════════════════════════════════════════════════════════
\usepackage{fancyhdr}

\pagestyle{fancy}
\fancyhf{}
\fancyhead[LE,RO]{\small\bfseries\thepage}              % Page numbers
\fancyhead[RE]{\small\nouppercase{\leftmark}}           % Chapter on even pages
\fancyhead[LO]{\small\nouppercase{\rightmark}}          % Section on odd pages
\renewcommand{\headrulewidth}{0.5pt}
\renewcommand{\footrulewidth}{0pt}

% Plain style for chapter pages
\fancypagestyle{plain}{
  \fancyhf{}
  \fancyfoot[C]{\small\thepage}
  \renewcommand{\headrulewidth}{0pt}
}

% ═══════════════════════════════════════════════════════════════════════════
% 11. HYPERLINKS — PDF Metadata & Links
% ═══════════════════════════════════════════════════════════════════════════
\usepackage[
  unicode=true,
  pdfencoding=auto,
  hidelinks,                        % No colored boxes around links
  bookmarks=true,
  bookmarksnumbered=true,
  bookmarksopen=true,
  pdftitle={رفيق الرعاية: العلاج الطبيعي لكبار السن في المنزل},
  pdfauthor={عبدالكريم بن محمد الدوسري},
  pdfsubject={العلاج الطبيعي لكبار السن},
  pdfkeywords={علاج طبيعي، كبار السن، رعاية منزلية},
  pdfproducer={XeLaTeX with Professional Publisher Quality Settings},
  pdfcreator={LaTeX}
]{hyperref}
\usepackage{bookmark}

% ═══════════════════════════════════════════════════════════════════════════
% 12. SPECIAL BOXES & ENVIRONMENTS
% ═══════════════════════════════════════════════════════════════════════════
\usepackage{mdframed}

% Box colors
\definecolor{storycolor}{RGB}{245,245,250}
\definecolor{storyborder}{RGB}{100,120,150}
\definecolor{tipcolor}{RGB}{240,248,245}
\definecolor{tipborder}{RGB}{60,140,100}
\definecolor{warncolor}{RGB}{255,248,240}
\definecolor{warnborder}{RGB}{200,120,60}
\definecolor{scenariocolor}{RGB}{250,250,255}
\definecolor{scenarioborder}{RGB}{80,100,140}

% Simple note box with left border - Compact version
\newmdenv[
  linecolor=accentcolor,
  linewidth=2pt,
  leftline=true,
  rightline=false,
  topline=false,
  bottomline=false,
  innerleftmargin=10pt,              % Reduced from 12pt
  innerrightmargin=10pt,             % Reduced from 12pt
  innertopmargin=8pt,                % Reduced from 10pt
  innerbottommargin=8pt,             % Reduced from 10pt
  skipabove=8pt plus 2pt minus 1pt,  % Reduced from 12pt
  skipbelow=8pt plus 2pt minus 1pt   % Reduced from 12pt
]{notebox}

% Story box environment - Compact
\newenvironment{storybox}{%
  \par\vspace{8pt plus 2pt minus 1pt}%  % Reduced from 12pt
  \noindent\hspace{0pt}%
  \begin{minipage}[t]{0.96\linewidth}%   % Slightly wider
  \textcolor{storyborder}{\rule[-2pt]{3pt}{1.1em}}\hspace{8pt}%  % Thinner rule
}{%
  \end{minipage}%
  \par\vspace{8pt plus 2pt minus 1pt}%   % Reduced from 12pt
}

% Tip box environment - Compact
\newenvironment{tipbox}{%
  \par\vspace{8pt plus 2pt minus 1pt}%
  \noindent\hspace{0pt}%
  \begin{minipage}[t]{0.96\linewidth}%
  \textcolor{tipborder}{\rule[-2pt]{3pt}{1.1em}}\hspace{8pt}%
}{%
  \end{minipage}%
  \par\vspace{8pt plus 2pt minus 1pt}%
}

% Warning box environment - Compact
\newenvironment{warnbox}{%
  \par\vspace{8pt plus 2pt minus 1pt}%
  \noindent\hspace{0pt}%
  \begin{minipage}[t]{0.96\linewidth}%
  \textcolor{warnborder}{\rule[-2pt]{3pt}{1.1em}}\hspace{8pt}%
}{%
  \end{minipage}%
  \par\vspace{8pt plus 2pt minus 1pt}%
}

% Scenario box environment - Compact
\newenvironment{scenariobox}{%
  \par\vspace{6pt plus 1pt minus 1pt}%   % Reduced from 10pt
  \noindent\hspace{0pt}%
  \begin{minipage}[t]{0.96\linewidth}%
  \textcolor{scenarioborder}{\rule[-2pt]{3pt}{1.1em}}\hspace{8pt}%
}{%
  \end{minipage}%
  \par\vspace{6pt plus 1pt minus 1pt}%   % Reduced from 10pt
}

% ═══════════════════════════════════════════════════════════════════════════
% 13. HELPER COMMANDS
% ═══════════════════════════════════════════════════════════════════════════

% Tight list for markdown compatibility - More compact
\providecommand{\tightlist}{%
  \setlength{\itemsep}{2pt}\setlength{\parskip}{1pt}%  % More compact
}

% Decorative section break - Compact
\newcommand{\sectionbreak}{%
  \par\vspace{10pt plus 2pt minus 1pt}%  % Reduced from 14pt
  \noindent\hfil\textcolor{accentcolor}{\rule{0.2\textwidth}{0.5pt}}\hfil%  % Shorter rule
  \par\vspace{10pt plus 2pt minus 1pt}%  % Reduced from 14pt
}

% Visual separator - Compact
\newcommand{\ornamentbreak}{%
  \par\vspace{8pt plus 1pt minus 1pt}%   % Reduced from 12pt
  \noindent\hfil{\textcolor{accentcolor}{* * *}}\hfil%
  \par\vspace{8pt plus 1pt minus 1pt}%   % Reduced from 12pt
}

% ═══════════════════════════════════════════════════════════════════════════
% 14. FINAL OPTIMIZATION SETTINGS
% ═══════════════════════════════════════════════════════════════════════════

% Ensure proper RTL layout
\setlength{\footnotemargin}{0.8em}

% Optimize for XeLaTeX
\XeTeXlinebreaklocale "ar"          % Arabic line breaking rules
\XeTeXlinebreakskip = 0pt plus 1pt  % Allow some flexibility in line breaks

% PDF compression for smaller file size
\pdfcompresslevel=9
\pdfobjcompresslevel=3

% ═══════════════════════════════════════════════════════════════════════════
% END OF PREAMBLE
% Professional Publisher Quality B5 RTL Setup Complete
% ═══════════════════════════════════════════════════════════════════════════
