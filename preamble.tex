% =============================================================================
% رفيق الرعاية — تنسيق احترافي احترافي B5 بجودة النشر
% Publisher Quality Professional Preamble
% =============================================================================

% ═══════════════════════════════════════════════════════════════════════════
% 1. PAPER SIZE & GEOMETRY — B5 with Golden Ratio Margins
% ═══════════════════════════════════════════════════════════════════════════
\usepackage[
  b5paper,
  top=25mm,
  bottom=25mm,
  inner=25mm,
  outer=20mm,
  headheight=22pt,
  headsep=8mm,
  footskip=10mm,
  marginparwidth=15mm,
  marginparsep=3mm
]{geometry}

% ═══════════════════════════════════════════════════════════════════════════
% 2. MICROTYPE — Professional Microtypography (CRITICAL FOR QUALITY)
% ═══════════════════════════════════════════════════════════════════════════
% Note: microtype has limited support for RTL, but we enable what works
\usepackage[
  activate={true,nocompatibility},
  final,
  tracking=false,
  kerning=false,
  factor=1100,
  stretch=20,
  shrink=20
]{microtype}

% ═══════════════════════════════════════════════════════════════════════════
% 3. COLORS — Sophisticated Professional Palette
% ═══════════════════════════════════════════════════════════════════════════
\usepackage{xcolor}
\definecolor{chaptercolor}{RGB}{20,50,80}         % Deep navy blue for chapters
\definecolor{sectioncolor}{RGB}{30,65,100}        % Rich blue for sections
\definecolor{accentcolor}{RGB}{139,69,19}         % Elegant brown accent
\definecolor{rulecolor}{RGB}{180,160,140}         % Warm decorative rules
\definecolor{tableheader}{RGB}{245,243,240}       % Warm cream for table headers
\definecolor{tipborder}{RGB}{30,65,100}           % Used for checkmarks in tables
\definecolor{ornamentcolor}{RGB}{160,140,120}     % Decorative ornaments
\definecolor{quoteback}{RGB}{250,248,245}         % Light cream for quotes
\newcommand{\tableheadercolor}{\rowcolor{tableheader}}


% ═══════════════════════════════════════════════════════════════════════════
% 4. FONTS & TYPOGRAPHY — Professional RTL Arabic Setup
% ═══════════════════════════════════════════════════════════════════════════
\usepackage{fontspec}
\usepackage[bidi=default, layout=sectionsingroup]{babel}
\babelprovide[import, main, mapdigits]{arabic}
\babelprovide[import]{english}

% Amiri is an excellent choice for professional Arabic typography
\babelfont[arabic]{rm}[
  Scale=1.05,
  Renderer=Harfbuzz
]{Amiri}

\babelfont[english]{rm}[
  Numbers=OldStyle,
  Renderer=Harfbuzz
]{TeX Gyre Termes}

% ═══════════════════════════════════════════════════════════════════════════
% 5. PAGE BREAKING & PENALTIES — MAXIMUM QUALITY (CRITICAL!)
% ═══════════════════════════════════════════════════════════════════════════

% === Widow and Orphan Control (MAXIMUM PENALTIES) ===
\widowpenalty=10000                 % Prevent widows (last line alone on new page)
\clubpenalty=10000                  % Prevent orphans (first line alone at bottom)
\brokenpenalty=10000                % Prevent broken words across pages

% === Display Penalties (keep equations/lists together) ===
\displaywidowpenalty=10000          % Widow penalty before display math
\predisplaypenalty=10000            % Penalty before display environments
\postdisplaypenalty=10000           % Penalty after display environments

% === Paragraph Breaking Penalties ===
\interlinepenalty=0                 % Allow breaks between lines (needed for flexibility)
\hyphenpenalty=50                   % Low penalty for hyphenation (Arabic rarely needs this)
\exhyphenpenalty=50                 % Explicit hyphen penalty

% === Page Breaking Control ===
\raggedbottom                       % Allow variable page heights (better than stretching)

% === CRITICAL: Prevent breaks after headings ===
\clubpenalties=3 10000 10000 5000   % Very strong penalties for club lines (first lines)
\widowpenalties=3 10000 10000 5000  % Very strong penalties for widow lines (last lines)
\displaywidowpenalties=3 10000 10000 5000  % Same for display math

% === Emergency Stretch — Allow paragraphs to stretch/shrink ===
\emergencystretch=2.5em             % Emergency stretch (helps avoid overfull boxes)
\tolerance=2000                     % Moderate tolerance for better justification
\hbadness=2000                      % Reasonable warning threshold
\vbadness=2000                      % Reasonable warning threshold

% === Flexible Spacing for Better Page Breaks — PROFESSIONAL ===
\setlength{\parskip}{5pt plus 3pt minus 2pt}    % More flexible paragraph spacing
\setlength{\parindent}{1.2em}                    % Slightly smaller indent for B5

% === Line Spacing — Professional for B5 ===
\linespread{1.15}                   % Slightly tighter for better page utilization

% === Flexible Vertical Spacing — PROFESSIONAL ===
\setlength{\topskip}{10pt plus 3pt minus 2pt}   % Flexible top skip
\setlength{\partopsep}{0pt plus 1pt}            % Flexible list spacing

% === Prevent Page Breaks After Headings (Sticky Headings) ===
% Use \nopagebreak and \samepage instead of needspace for XeLaTeX compatibility

% ═══════════════════════════════════════════════════════════════════════════
% 6. ADVANCED SQUEEZE COMMANDS — Font Shrinking for Tight Fitting
% ═══════════════════════════════════════════════════════════════════════════

% Command to slightly shrink text to fit on previous page (use sparingly!)
\newcommand{\squeezepage}{%
  \enlargethispage{2\baselineskip}%           % Add 2 extra lines to page
  \setlength{\parskip}{4pt plus 1pt minus 2pt}% Tighter paragraph spacing
}

% Command for maximum squeeze (emergency use only)
\newcommand{\maxsqueeze}{%
  \enlargethispage{3\baselineskip}%           % Add 3 extra lines
  \setlength{\parskip}{3pt plus 1pt minus 2pt}% Very tight spacing
  \linespread{1.10}\selectfont%               % Tighter line spacing
}

% Restore normal spacing after squeeze
\newcommand{\normalsqueeze}{%
  \setlength{\parskip}{6pt plus 2pt minus 1pt}%  % Updated to match new default
  \linespread{1.18}\selectfont%                   % Updated to match new default
}

% === First Paragraph After Heading - No Indent ===
\usepackage{indentfirst}              % Indent first paragraph (Arabic standard)

% === Drop Caps for Chapter Opening (Optional Enhancement) ===
% \usepackage{lettrine}               % Uncomment for decorative first letters

% ═══════════════════════════════════════════════════════════════════════════
% 7. CHAPTER & SECTION FORMATTING — Elegant Professional Design
% ═══════════════════════════════════════════════════════════════════════════
\usepackage{titlesec}
\usepackage{titletoc}

% === CHAPTER FORMAT — Elegant Publisher Quality Opening Page ===
\titleformat{\chapter}[display]
  {\normalfont\centering}
  {% Chapter number with decorative frame
    \vspace*{1.5cm}%
    {\textcolor{ornamentcolor}{— — —}}\\[0.6cm]%
    \textcolor{chaptercolor!25}{%
      \fontsize{80}{90}\selectfont\bfseries\arabic{chapter}%
    }%
    \\[0.4cm]%
    {\textcolor{ornamentcolor}{— — —}}%
  }
  {0pt}
  {% Chapter title
    \vspace{0.6cm}%
    \fontsize{24}{30}\selectfont\bfseries\textcolor{chaptercolor}%
  }
  [% After chapter title - elegant decorative element
    \vspace{0.6cm}%
    {\textcolor{rulecolor}{\rule{0.4\textwidth}{0.8pt}}}%
    \vspace{1.5cm}%
  ]

% Chapter spacing
\titlespacing*{\chapter}
  {0pt}
  {0pt}
  {25pt plus 8pt minus 5pt}

% === SECTION FORMAT — Elegant with subtle decoration ===
\titleformat{\section}
  {\normalfont\fontsize{16}{20}\selectfont\bfseries\color{sectioncolor}}
  {}
  {0pt}
  {}
  [\vspace{2pt}{\textcolor{rulecolor!60}{\rule{0.15\textwidth}{0.5pt}}}]

\titlespacing*{\section}
  {0pt}
  {14pt plus 3pt minus 2pt}
  {8pt plus 2pt minus 1pt}

% === SUBSECTION FORMAT — Clean and refined ===
\titleformat{\subsection}
  {\normalfont\fontsize{13}{17}\selectfont\bfseries\color{chaptercolor!80}}
  {}
  {0pt}
  {}

\titlespacing*{\subsection}
  {0pt}
  {10pt plus 2pt minus 2pt}
  {5pt plus 1pt minus 1pt}

% === CRITICAL: Prevent Heading Orphans and Page Breaks ===
% Load needspace package for better control
\usepackage{needspace}

% Command to ensure minimum space before headings
\newcommand{\chapternobreak}{\needspace{10\baselineskip}}
\newcommand{\sectionnobreak}{\needspace{5\baselineskip}}
\newcommand{\subsectionnobreak}{\needspace{4\baselineskip}}

% Redefine chapter to ensure proper page breaks
\let\oldchapter\chapter
\renewcommand{\chapter}{%
  \clearpage%
  \oldchapter%
}

% Redefine section to prevent orphans and ensure space
\let\oldsection\section
\renewcommand{\section}{%
  \needspace{5\baselineskip}%           % Ensure 5 lines available
  \oldsection%
  \nopagebreak[4]%                      % Strongly prevent break after title
  \@afterheading%                       % Prevent break after heading
}

% Redefine subsection with same protections
\let\oldsubsection\subsection
\renewcommand{\subsection}{%
  \needspace{4\baselineskip}%           % Ensure 4 lines available
  \oldsubsection%
  \nopagebreak[4]%                      % Strongly prevent break after title
  \@afterheading%                       % Prevent break after heading
}

% Additional protection for starred sections (unnumbered)
\let\oldsectionstar\section*
\renewcommand{\section*}{%
  \needspace{5\baselineskip}%
  \oldsectionstar%
  \nopagebreak[4]%
  \@afterheading%
}

\let\oldsubsectionstar\subsection*
\renewcommand{\subsection*}{%
  \needspace{4\baselineskip}%
  \oldsubsectionstar%
  \nopagebreak[4]%
  \@afterheading%
}

% ═══════════════════════════════════════════════════════════════════════════
% 8. GRAPHICS & TABLES — Elegant Professional Styling
% ═══════════════════════════════════════════════════════════════════════════
\usepackage{graphicx}
\usepackage{booktabs}
\usepackage{longtable}
\usepackage{calc}
\usepackage{array}
\usepackage{tabularx}
\usepackage{multirow}
\usepackage{colortbl}
\usepackage{makecell}
\usepackage{amssymb}

% Elegant Table Settings
\renewcommand{\arraystretch}{1.35}
\setlength{\tabcolsep}{6pt}

% Professional booktabs styling
\renewcommand{\toprule}{\specialrule{0.8pt}{0pt}{4pt}}
\renewcommand{\midrule}{\specialrule{0.4pt}{3pt}{3pt}}
\renewcommand{\bottomrule}{\specialrule{0.8pt}{4pt}{0pt}}

% ═══════════════════════════════════════════════════════════════════════════
% 9. LISTS — Elegant Professional Styling
% ═══════════════════════════════════════════════════════════════════════════
\usepackage{enumitem}

% Compact lists with elegant styling
\setlist{nosep, topsep=4pt, partopsep=2pt}
\setlist[itemize]{leftmargin=1.2em, label={\textcolor{accentcolor}{—}}}
\setlist[itemize,2]{label={\textcolor{ornamentcolor}{·}}}
\setlist[enumerate]{leftmargin=1.5em}
\setlist[enumerate,1]{label={\textcolor{chaptercolor}{\arabic*.}}}
\setlist[enumerate,2]{label={\textcolor{sectioncolor}{\alph*.}}}

% ═══════════════════════════════════════════════════════════════════════════
% 10. HEADERS & FOOTERS — Elegant Professional Page Headers
% ═══════════════════════════════════════════════════════════════════════════
\usepackage{fancyhdr}

\pagestyle{fancy}
\fancyhf{}

% Elegant header rule
\renewcommand{\headrule}{\vspace{-4pt}\textcolor{rulecolor!50}{\rule{\textwidth}{0.4pt}}}

% Page Numbers with decorative elements on Outer Edges
\fancyhead[RE,LO]{\textcolor{chaptercolor}{\small\bfseries— \thepage{} —}}

% Chapter/Section Info on Inner Edges with elegant styling
\fancyhead[LE]{\small\textcolor{chaptercolor!70}{\nouppercase{\leftmark}}}
\fancyhead[RO]{\small\textcolor{sectioncolor!70}{\nouppercase{\rightmark}}}

\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}

% Plain style for chapter opening pages - elegant centered number
\fancypagestyle{plain}{
  \fancyhf{}
  \fancyfoot[C]{\textcolor{chaptercolor}{\small— \thepage{} —}}
  \renewcommand{\headrulewidth}{0pt}
}

% ═══════════════════════════════════════════════════════════════════════════
% 11. HYPERLINKS — PDF Metadata & Links
% ═══════════════════════════════════════════════════════════════════════════
\usepackage[
  unicode=true,
  pdfencoding=auto,
  hidelinks,                        % No colored boxes around links
  bookmarks=true,
  bookmarksnumbered=true,
  bookmarksopen=true,
  pdftitle={رفيق الرعاية: العلاج الطبيعي لكبار السن في المنزل},
  pdfauthor={عبدالكريم بن محمد الدوسري},
  pdfsubject={العلاج الطبيعي لكبار السن},
  pdfkeywords={علاج طبيعي، كبار السن، رعاية منزلية},
  pdfproducer={XeLaTeX with Professional Publisher Quality Settings},
  pdfcreator={LaTeX}
]{hyperref}
\usepackage{bookmark}

% ═══════════════════════════════════════════════════════════════════════════
% 12. SPECIAL BOXES & ENVIRONMENTS — Elegant Professional Design
% ═══════════════════════════════════════════════════════════════════════════

% Load tcolorbox for beautiful boxes
\usepackage[most]{tcolorbox}

% Elegant note box
\newtcolorbox{notebox}{
  enhanced,
  colback=quoteback,
  colframe=rulecolor!50,
  boxrule=0.5pt,
  arc=2pt,
  left=8pt, right=8pt, top=6pt, bottom=6pt,
  before skip=10pt, after skip=10pt,
  fonttitle=\bfseries\color{chaptercolor},
  title=ملاحظة
}

% Elegant story/quote box
\newtcolorbox{storybox}{
  enhanced,
  colback=quoteback,
  colframe=accentcolor!40,
  boxrule=0pt,
  leftrule=3pt,
  arc=0pt,
  left=12pt, right=8pt, top=8pt, bottom=8pt,
  before skip=12pt, after skip=12pt,
  fontupper=\itshape
}

% Elegant tip box
\newtcolorbox{tipbox}{
  enhanced,
  colback=tableheader,
  colframe=sectioncolor!30,
  boxrule=0.5pt,
  arc=2pt,
  left=8pt, right=8pt, top=6pt, bottom=6pt,
  before skip=10pt, after skip=10pt,
  fonttitle=\bfseries\color{sectioncolor},
  title=تلميح
}

% Warning box with emphasis
\newtcolorbox{warnbox}{
  enhanced,
  colback=red!3,
  colframe=red!40,
  boxrule=0.5pt,
  arc=2pt,
  left=8pt, right=8pt, top=6pt, bottom=6pt,
  before skip=10pt, after skip=10pt,
  fonttitle=\bfseries\color{red!70!black},
  title=تحذير
}

% Scenario box with page break protection
\newenvironment{scenariobox}{%
  \needspace{4\baselineskip}%
  \nopagebreak[4]%
  \par\vspace{8pt}\noindent{\bfseries\textcolor{chaptercolor}{سيناريو:}}\space%
  \nopagebreak[4]%
}{%
  \par\vspace{8pt}%
}

% Special box environment (with title) - protected from page breaks
\newenvironment{specialbox}[1]{%
  \needspace{4\baselineskip}%
  \nopagebreak[4]%
  \par\vspace{10pt}\noindent{\bfseries\textcolor{sectioncolor}{#1}}\par\vspace{4pt}%
  \nopagebreak[4]%
}{%
  \par\vspace{8pt}%
}

% Warning box environment (long) - protected from page breaks
\newenvironment{warningbox}{%
  \needspace{4\baselineskip}%
  \nopagebreak[4]%
  \par\vspace{10pt}\noindent{\bfseries\textcolor{red!70!black}{تنبيه مهم:}}\par\vspace{4pt}%
  \nopagebreak[4]%
}{%
  \par\vspace{8pt}%
}

% ═══════════════════════════════════════════════════════════════════════════
% 13. HELPER COMMANDS — Elegant Decorative Elements
% ═══════════════════════════════════════════════════════════════════════════

% Tight list for markdown compatibility
\providecommand{\tightlist}{%
  \setlength{\itemsep}{3pt}\setlength{\parskip}{2pt}%
}

% === CRITICAL: Commands to protect important text from page breaks ===
% Use these to wrap important names, titles, or key phrases that should not be separated

% Protect a title or heading-like text with following content
\newcommand{\protectedtitle}[1]{%
  \needspace{3\baselineskip}%
  #1\nopagebreak[4]%
}

% Keep important name/title with its following description (at least 2 lines)
\newcommand{\keepwithnext}[1]{%
  #1\nopagebreak[4]%
}

% Start a protected block (prevents breaks for next few lines)
\newcommand{\startprotected}{\par\needspace{4\baselineskip}\nopagebreak[4]}

% Protect scenario boxes and similar important text blocks
\newcommand{\protectblock}[1]{%
  \needspace{5\baselineskip}%
  \nopagebreak[4]%
  #1%
  \nopagebreak[3]%
}

% Elegant decorative section break with ornament
\newcommand{\sectionbreak}{%
  \par\vspace{12pt}%
  \begin{center}%
    \textcolor{ornamentcolor}{$\diamond$\quad$\diamond$\quad$\diamond$}%
  \end{center}%
  \vspace{10pt}%
}

% Visual ornament break
\newcommand{\ornamentbreak}{%
  \par\vspace{10pt}%
  \begin{center}%
    \textcolor{rulecolor!60}{\rule{0.2\textwidth}{0.4pt}}%
  \end{center}%
  \vspace{8pt}%
}

% Elegant horizontal rule
\newcommand{\eleganthrule}{%
  \par\vspace{8pt}%
  {\centering\textcolor{rulecolor!50}{\rule{0.5\textwidth}{0.3pt}}\par}%
  \vspace{8pt}%
}

% Chapter end ornament
\newcommand{\chapterend}{%
  \vspace{20pt}%
  \begin{center}%
    \textcolor{ornamentcolor}{— $\diamond$ —}%
  \end{center}%
  \vspace{10pt}%
}

% ═══════════════════════════════════════════════════════════════════════════
% 14. FINAL OPTIMIZATION SETTINGS
% ═══════════════════════════════════════════════════════════════════════════

% Ensure proper RTL layout
% \setlength{\footnotemargin}{0.8em}

% Optimize for LuaLaTeX
% \XeTeXlinebreaklocale "ar"          % Removed: XeTeX specific
% \XeTeXlinebreakskip = 0pt plus 1pt  % Removed: XeTeX specific

% LuaLaTeX/XeLaTeX uses HarfBuzz by default with fontspec, so Arabic shaping should work out of the box.\n% Ensure microtype settings are compatible (already set to 'final' and compatible defaults).

% PDF compression for smaller file size
% \pdfcompresslevel=9
% \pdfobjcompresslevel=3

% ═══════════════════════════════════════════════════════════════════════════
% END OF PREAMBLE
% Professional Publisher Quality B5 RTL Setup Complete
% ═══════════════════════════════════════════════════════════════════════════
