% =============================================================================
% رفيق الرعاية — تنسيق احترافي احترافي B5 بجودة النشر
% Publisher Quality Professional Preamble
% =============================================================================

% ═══════════════════════════════════════════════════════════════════════════
% 1. PAPER SIZE & GEOMETRY — B5 with Golden Ratio Margins
% ═══════════════════════════════════════════════════════════════════════════
\usepackage[
  b5paper,                    % B5 format (176 x 250 mm)
  top=25mm,                   % Top margin
  bottom=25mm,                % Bottom margin
  inner=25mm,                 % Inner margin (binding side)
  outer=20mm,                 % Outer margin (slightly smaller - golden ratio inspired)
  headheight=14pt,            % Header height
  headsep=8mm,                % Space between header and text
  footskip=10mm,              % Space for footer
  marginparwidth=15mm,        % Margin notes width
  marginparsep=3mm            % Space to margin notes
]{geometry}

% ═══════════════════════════════════════════════════════════════════════════
% 2. MICROTYPE — Professional Microtypography (CRITICAL FOR QUALITY)
% ═══════════════════════════════════════════════════════════════════════════
% Note: microtype has limited support for RTL, but we enable what works
\usepackage[
  activate={true,nocompatibility},  % Activate protrusion and expansion
  final,                            % Enable in final mode
  tracking=false,                   % Disable tracking (spacing issues with Arabic)
  kerning=false,                    % Disable kerning (not needed for Arabic)
  % spacing=true,                     % Enable spacing adjustments (disabled for LuaLaTeX)
  factor=1100,                      % Protrusion factor (110%)
  stretch=20,                       % Font expansion: stretch by 2%
  shrink=20                         % Font expansion: shrink by 2% (helps fitting)
]{microtype}

% Fine-tune microtype settings for better paragraph fitting
\microtypecontext{spacing=nonfrench}

% ═══════════════════════════════════════════════════════════════════════════
% 3. COLORS — Professional Color Palette
% ═══════════════════════════════════════════════════════════════════════════
\usepackage{xcolor}
\definecolor{chaptercolor}{RGB}{25,55,85}       % Deep blue for chapters
\definecolor{sectioncolor}{RGB}{35,70,105}      % Medium blue for sections
\definecolor{accentcolor}{RGB}{60,90,120}       % Accent color
\definecolor{rulecolor}{RGB}{100,120,140}       % Decorative rules

% ═══════════════════════════════════════════════════════════════════════════
% 4. FONTS & TYPOGRAPHY — Professional RTL Arabic Setup
% ═══════════════════════════════════════════════════════════════════════════
\usepackage{fontspec}
\usepackage[bidi=basic, layout=sectionsingroup]{babel}
\babelprovide[import, main, mapdigits]{arabic}
\babelprovide[import]{english}

% Amiri is an excellent choice for professional Arabic typography
\babelfont[arabic]{rm}[
  Scale=1.05,
  Renderer=Harfbuzz
]{Amiri}

\babelfont[english]{rm}[
  Numbers=OldStyle,
  Renderer=Harfbuzz
]{TeX Gyre Termes}

% ═══════════════════════════════════════════════════════════════════════════
% 5. PAGE BREAKING & PENALTIES — MAXIMUM QUALITY (CRITICAL!)
% ═══════════════════════════════════════════════════════════════════════════

% === Widow and Orphan Control (MAXIMUM PENALTIES) ===
\widowpenalty=10000                 % Prevent widows (last line alone on new page)
\clubpenalty=10000                  % Prevent orphans (first line alone at bottom)
\brokenpenalty=10000                % Prevent broken words across pages

% === Display Penalties (keep equations/lists together) ===
\displaywidowpenalty=10000          % Widow penalty before display math
\predisplaypenalty=10000            % Penalty before display environments
\postdisplaypenalty=10000           % Penalty after display environments

% === Paragraph Breaking Penalties ===
\interlinepenalty=0                 % Allow breaks between lines (needed for flexibility)
\hyphenpenalty=50                   % Low penalty for hyphenation (Arabic rarely needs this)
\exhyphenpenalty=50                 % Explicit hyphen penalty

% === Page Breaking Control ===
\raggedbottom                       % Allow variable page heights (better than stretching)
\sloppypar                          % Allow slightly looser spacing to avoid overfull boxes

% === Emergency Stretch — Allow paragraphs to stretch/shrink ===
\emergencystretch=3em               % Maximum emergency stretch (helps avoid overfull boxes)
\tolerance=9999                     % Very high tolerance for line breaking
\hbadness=9999                      % Don't warn about underfull hboxes
\vbadness=9999                      % Don't warn about underfull vboxes

% === Flexible Spacing for Better Page Breaks — PROFESSIONAL ===
\setlength{\parskip}{6pt plus 2pt minus 1pt}    % Balanced paragraph spacing
\setlength{\parindent}{1.5em}                    % Professional paragraph indent

% === Line Spacing — Professional for B5 ===
\linespread{1.18}                   % Slightly increased for better readability
                                    % Professional publishing standard

% === Flexible Vertical Spacing — PROFESSIONAL ===
\setlength{\topskip}{10pt plus 2pt minus 1pt}   % Standard top skip
\setlength{\parskip}{6pt plus 2pt minus 1pt}    % Consistent paragraph spacing

% === Prevent Page Breaks After Headings (Sticky Headings) ===
\usepackage{needspace}              % For \needspace command

% ═══════════════════════════════════════════════════════════════════════════
% 6. ADVANCED SQUEEZE COMMANDS — Font Shrinking for Tight Fitting
% ═══════════════════════════════════════════════════════════════════════════

% Command to slightly shrink text to fit on previous page (use sparingly!)
\newcommand{\squeezepage}{%
  \enlargethispage{2\baselineskip}%           % Add 2 extra lines to page
  \setlength{\parskip}{4pt plus 1pt minus 2pt}% Tighter paragraph spacing
}

% Command for maximum squeeze (emergency use only)
\newcommand{\maxsqueeze}{%
  \enlargethispage{3\baselineskip}%           % Add 3 extra lines
  \setlength{\parskip}{3pt plus 1pt minus 2pt}% Very tight spacing
  \linespread{1.10}\selectfont%               % Tighter line spacing
}

% Restore normal spacing after squeeze
\newcommand{\normalsqueeze}{%
  \setlength{\parskip}{6pt plus 2pt minus 1pt}%  % Updated to match new default
  \linespread{1.18}\selectfont%                   % Updated to match new default
}

% === First Paragraph After Heading - No Indent ===
\usepackage{indentfirst}              % Indent first paragraph (Arabic standard)

% === Drop Caps for Chapter Opening (Optional Enhancement) ===
% \usepackage{lettrine}               % Uncomment for decorative first letters

% ═══════════════════════════════════════════════════════════════════════════
% 7. CHAPTER & SECTION FORMATTING — Elegant Professional Design
% ═══════════════════════════════════════════════════════════════════════════
\usepackage{titlesec}
\usepackage{titletoc}

% === CHAPTER FORMAT — Publisher Quality Opening Page ===
\titleformat{\chapter}[display]
  {\normalfont\centering}
  {% Chapter number - elegant large number
    \vspace*{2cm}%                   % Generous top space for chapter opening
    \textcolor{chaptercolor!30}{%
      \fontsize{72}{80}\selectfont\bfseries\arabic{chapter}%  % Large, light number
    }%
  }
  {0pt}
  {% Chapter title - prominent and clear
    \vspace{0.8cm}%                  % Good spacing after number
    \fontsize{22}{28}\selectfont\bfseries\textcolor{chaptercolor}%  % Clear title
  }
  [% After chapter title - decorative element
    \vspace{0.5cm}%
    \textcolor{rulecolor}{\rule{0.3\textwidth}{1pt}}%  % Elegant rule
    \vspace{1.2cm}%                  % Breathing room before content
  ]

% Chapter spacing - professional opening page
\titlespacing*{\chapter}
  {0pt}                             % Left margin
  {0pt}                             % No extra space before (chapter starts fresh page)
  {30pt plus 10pt minus 5pt}        % Space after - generous for opening

% === SECTION FORMAT — Clean Standard ===
\titleformat{\section}
  {\normalfont\fontsize{15}{19}\selectfont\bfseries\color{sectioncolor}}
  {}
  {0pt}
  {}

\titlespacing*{\section}
  {0pt}
  {10pt plus 2pt minus 2pt}
  {6pt plus 1pt minus 1pt}

% === SUBSECTION FORMAT — Clean Standard ===
\titleformat{\subsection}
  {\normalfont\fontsize{13}{16}\selectfont\bfseries\color{black!85}}
  {}
  {0pt}
  {}

\titlespacing*{\subsection}
  {0pt}
  {8pt plus 2pt minus 2pt}
  {4pt plus 1pt minus 1pt}

% === Prevent Heading Orphans ===
\newcommand{\chapternobreak}{\needspace{8\baselineskip}}
\newcommand{\sectionnobreak}{\needspace{4\baselineskip}}
\newcommand{\subsectionnobreak}{\needspace{3\baselineskip}}

\let\oldchapter\chapter
\renewcommand{\chapter}{\clearpage\chapternobreak\oldchapter}

\let\oldsection\section
\renewcommand{\section}{\sectionnobreak\oldsection}

\let\oldsubsection\subsection
\renewcommand{\subsection}{\subsectionnobreak\oldsubsection}

% ═══════════════════════════════════════════════════════════════════════════
% 8. GRAPHICS & TABLES — Standard
% ═══════════════════════════════════════════════════════════════════════════
\usepackage{graphicx}
\usepackage{booktabs}
\usepackage{longtable}
\usepackage{calc}
\usepackage{array}
\usepackage{tabularx}
\usepackage{multirow}
\usepackage{colortbl}
\usepackage{amssymb}

% Standard Table Settings
\renewcommand{\arraystretch}{1.2}

% ═══════════════════════════════════════════════════════════════════════════
% 9. LISTS — Standard
% ═══════════════════════════════════════════════════════════════════════════
\usepackage{enumitem}
% Reset to mostly standard, just slightly tighter for B5
\setlist{nosep} % Compact lists
\setlist[itemize]{leftmargin=*}
\setlist[enumerate]{leftmargin=*}

% ═══════════════════════════════════════════════════════════════════════════
% 10. HEADERS & FOOTERS — Professional Page Headers
% ═══════════════════════════════════════════════════════════════════════════
\usepackage{fancyhdr}

\pagestyle{fancy}
\fancyhf{}

% In RTL Context (Arabic):
% Even pages are on the RIGHT. Outer edge is RIGHT. Inner edge is LEFT.
% Odd pages are on the LEFT. Outer edge is LEFT. Inner edge is RIGHT.

% Page Numbers on Outer Edges:
% RE (Right Even) -> Outer
% LO (Left Odd)   -> Outer
\fancyhead[RE,LO]{\small\bfseries\thepage}

% Chapter/Section Info on Inner Edges:
% LE (Left Even)  -> Inner -> Chapter
% RO (Right Odd)  -> Inner -> Section
\fancyhead[LE]{\small\nouppercase{\leftmark}}           % Chapter on even pages (Inner)
\fancyhead[RO]{\small\nouppercase{\rightmark}}          % Section on odd pages (Inner)

\renewcommand{\headrulewidth}{0.5pt}
\renewcommand{\footrulewidth}{0pt}

% Plain style for chapter pages
\fancypagestyle{plain}{
  \fancyhf{}
  \fancyfoot[C]{\small\thepage} % Centered page number on chapter start pages is standard
  \renewcommand{\headrulewidth}{0pt}
}

% ═══════════════════════════════════════════════════════════════════════════
% 11. HYPERLINKS — PDF Metadata & Links
% ═══════════════════════════════════════════════════════════════════════════
\usepackage[
  unicode=true,
  pdfencoding=auto,
  hidelinks,                        % No colored boxes around links
  bookmarks=true,
  bookmarksnumbered=true,
  bookmarksopen=true,
  pdftitle={رفيق الرعاية: العلاج الطبيعي لكبار السن في المنزل},
  pdfauthor={عبدالكريم بن محمد الدوسري},
  pdfsubject={العلاج الطبيعي لكبار السن},
  pdfkeywords={علاج طبيعي، كبار السن، رعاية منزلية},
  pdfproducer={XeLaTeX with Professional Publisher Quality Settings},
  pdfcreator={LaTeX}
]{hyperref}
\usepackage{bookmark}

% ═══════════════════════════════════════════════════════════════════════════
% 12. SPECIAL BOXES & ENVIRONMENTS
% ═══════════════════════════════════════════════════════════════════════════
% 12. SPECIAL BOXES & ENVIRONMENTS — SIMPLIFIED
% ═══════════════════════════════════════════════════════════════════════════

% Simple note box
\newenvironment{notebox}{%
  \par\vspace{8pt}\noindent\textbf{ملاحظة:}\space
}{%
  \par\vspace{8pt}
}

% Story box environment
\newenvironment{storybox}{%
  \par\vspace{8pt}\noindent\textbf{من الواقع:}\space\itshape
}{%
  \par\vspace{8pt}
}

% Tip box environment
\newenvironment{tipbox}{%
  \par\vspace{8pt}\noindent\textbf{تلميح:}\space
}{%
  \par\vspace{8pt}
}

% Warning box environment
\newenvironment{warnbox}{%
  \par\vspace{8pt}\noindent\textbf{تحذير:}\space
}{%
  \par\vspace{8pt}
}

% Scenario box environment
\newenvironment{scenariobox}{%
  \par\vspace{6pt}\noindent\textbf{سيناريو:}\space
}{%
  \par\vspace{6pt}
}

% Special box environment (with title)
\newenvironment{specialbox}[1]{%
  \par\vspace{10pt}\noindent\textbf{#1}\par
}{%
  \par\vspace{6pt}
}

% Warning box environment (long)
\newenvironment{warningbox}{%
  \par\vspace{10pt}\noindent\textbf{تنبيه مهم:}\par
}{%
  \par\vspace{6pt}
}

% ═══════════════════════════════════════════════════════════════════════════
% 13. HELPER COMMANDS — SIMPLIFIED
% ═══════════════════════════════════════════════════════════════════════════

% Tight list for markdown compatibility
\providecommand{\tightlist}{%
  \setlength{\itemsep}{2pt}\setlength{\parskip}{1pt}%
}

% Decorative section break - REMOVED (Just space)
\newcommand{\sectionbreak}{%
  \par\vspace{14pt}
}

% Visual ornament - REMOVED (Just space)
\newcommand{\ornamentbreak}{%
  \par\vspace{12pt}
}

% ═══════════════════════════════════════════════════════════════════════════
% 14. FINAL OPTIMIZATION SETTINGS
% ═══════════════════════════════════════════════════════════════════════════

% Ensure proper RTL layout
% \setlength{\footnotemargin}{0.8em}

% Optimize for LuaLaTeX
% \XeTeXlinebreaklocale "ar"          % Removed: XeTeX specific
% \XeTeXlinebreakskip = 0pt plus 1pt  % Removed: XeTeX specific

% LuaLaTeX uses HarfBuzz by default with fontspec, so Arabic shaping should work out of the box.
% Ensure microtype settings are compatible (already set to 'final' and compatible defaults).
\usepackage{luacode} % Good to have for LuaLaTeX power if needed

% PDF compression for smaller file size
% \pdfcompresslevel=9
% \pdfobjcompresslevel=3

% ═══════════════════════════════════════════════════════════════════════════
% END OF PREAMBLE
% Professional Publisher Quality B5 RTL Setup Complete
% ═══════════════════════════════════════════════════════════════════════════
